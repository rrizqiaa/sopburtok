<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Inventory - SOP BURTOK</title>
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
  <div class="dashboard-wrapper">
    <!-- Sidebar -->
    <div class="sidebar">
      <img src="assets/images/logo.png" alt="SOP BURTOK" />
      <h3>SOP BURTOK</h3>
      <button class="menu-btn" onclick="location.href='dashboard.html'">Home</button>
      <button class="menu-btn active" onclick="location.href='inventory.html'">Inventory</button>
      <button class="menu-btn" onclick="location.href='production.html'">Production</button>
      <button class="menu-btn" onclick="location.href='reporting.html'">Reporting</button>
      <button class="menu-btn" onclick="location.href='profile.html'">Profile</button>
      <button class="menu-btn" onclick="location.href='Kalkulator.html'">Kalkulator</button>

    </div>

    <!-- Top Bar -->
    <div class="top-bar">
      <div id="liveClock" style="margin-right: 15px; font-weight: bold;"></div>
      <button class="toggle-mode-btn" onclick="toggleMode()" style="margin-right: 10px;">üåì</button>
      <button class="logout-btn" onclick="logoutUser()">Logout</button>
    </div>

    <!-- Content -->
    <div class="content">
      <h2>‚ö†Ô∏è Peringatan Bahan Baku</h2>
      <table class="stock-table" style="background-color: #fff4f4;">
        <thead>
          <tr>
            <th>Nama</th>
            <th>Masalah</th>
          </tr>
        </thead>
        <tbody id="warningTableBody"></tbody>
      </table>

      <h2 style="margin-top: 30px;">Inventory Bahan Baku</h2>
      <button onclick="showAddForm()">+ Tambah Bahan Baku</button>

      <div id="addStockForm" class="hidden" style="margin-top: 20px;">
        <input id="stockName" placeholder="Nama Bahan Baku" />
        <select id="stockCategory">
          <option value="Sayuran">Sayuran</option>
          <option value="Pokok">Pokok</option>
          <option value="Bumbu">Bumbu</option>
        </select>
        <input id="stockEntry" type="date" />
        <input id="stockAmount" type="number" placeholder="Jumlah" />
        <button onclick="addInventory()">Simpan</button>
        <button onclick="hideAddForm()">Batal</button>
      </div>

      <table class="stock-table">
        <thead>
          <tr>
            <th>Nama</th>
            <th>Kategori</th>
            <th>Tanggal Masuk</th>
            <th>Jumlah</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="stockTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Clock -->
  <script>
    function updateLiveClock() {
      const el = document.getElementById("liveClock");
      const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
      const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
      const now = new Date();
      el.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()} - ${now.toLocaleTimeString("id-ID")}`;
    }
    setInterval(updateLiveClock, 1000);
    updateLiveClock();
  </script>

  <!-- Mode -->
  <script>
    function toggleMode() {
      const isDark = document.body.classList.toggle("dark-mode");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-mode");
      }
    });
  </script>

  <!-- Script -->
  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "index.html";

    function showAddForm() {
      document.getElementById("addStockForm").classList.remove("hidden");
    }

    function hideAddForm() {
      document.getElementById("addStockForm").classList.add("hidden");
    }

    async function loadInventory() {
      try {
        const res = await fetch("https://api.sopburtok.giize.com/api/inventory", {
          headers: { Authorization: `Bearer ${token}`, Accept: "application/json" }
        });
        const data = await res.json();
        renderStockTable(data);
        checkStockAlerts(data);
      } catch (err) {
        console.error("Gagal memuat data:", err);
      }
    }

    function renderStockTable(data) {
      const tbody = document.getElementById("stockTableBody");
      tbody.innerHTML = "";

      data.forEach(item => {
        const row = document.createElement("tr");
        const nameLower = item.name?.toLowerCase() || "";
        const unit = (nameLower === "air" || nameLower === "minyak") ? "Liter" : "Kg";

        row.innerHTML = `
          <td><input value="${item.name}" onchange="updateInventory(${item.id}, 'name', this.value)" /></td>
          <td>
            <select onchange="updateInventory(${item.id}, 'category', this.value)">
              <option value="Sayuran" ${item.category === "Sayuran" ? "selected" : ""}>Sayuran</option>
              <option value="Pokok" ${item.category === "Pokok" ? "selected" : ""}>Pokok</option>
              <option value="Bumbu" ${item.category === "Bumbu" ? "selected" : ""}>Bumbu</option>
            </select>
          </td>
          <td><input type="date" value="${item.entry_date}" onchange="updateInventory(${item.id}, 'entry_date', this.value)" /></td>
          <td>
            <input type="number" value="${item.stock}" onchange="updateInventory(${item.id}, 'stock', this.value)" style="width: 80px;" /> ${unit}
          </td>
          <td><button onclick="deleteInventory(${item.id})">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function checkStockAlerts(data) {
      const warningTable = document.getElementById("warningTableBody");
      warningTable.innerHTML = "";

      const now = new Date();
      const lowThreshold = 5;

      data.forEach(item => {
        const masalah = [];
        const nameLower = item.name?.toLowerCase() || "";
        const unit = (nameLower === "air" || nameLower === "minyak") ? "Liter" : "Kg";
        const jumlah = item.stock || 0;

        if (jumlah < lowThreshold) {
          masalah.push(`Stok rendah (${jumlah} ${unit})`);
        }

        if (item.entry_date) {
          const entryDate = new Date(item.entry_date);
          const daysStored = Math.floor((now - entryDate) / (1000 * 60 * 60 * 24));
          if (daysStored >= 7) {
            masalah.push(`Tersimpan ${daysStored} hari`);
          }
        }

        if (masalah.length > 0) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${masalah.join("<br>")}</td>
          `;
          warningTable.appendChild(row);
        }
      });
    }

    async function addInventory() {
      const body = {
        name: document.getElementById("stockName").value,
        category: document.getElementById("stockCategory").value,
        entry_date: document.getElementById("stockEntry").value,
        stock: parseFloat(document.getElementById("stockAmount").value)
      };

      const res = await fetch("https://api.sopburtok.giize.com/api/inventory", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
          Accept: "application/json"
        },
        body: JSON.stringify(body)
      });

      if (res.ok) {
        alert("‚úÖ Berhasil ditambahkan");
        hideAddForm();
        loadInventory();
      } else {
        alert("‚ùå Gagal menambahkan data");
      }
    }

    async function updateInventory(id, field, value) {
      await fetch(`https://api.sopburtok.giize.com/api/inventory/${id}`, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
          Accept: "application/json"
        },
        body: JSON.stringify({ [field]: value })
      });
    }

    async function deleteInventory(id) {
      if (!confirm("Hapus bahan baku ini?")) return;
      await fetch(`https://api.sopburtok.giize.com/api/inventory/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}`, Accept: "application/json" }
      });
      loadInventory();
    }

    function logoutUser() {
      fetch("https://api.sopburtok.giize.com/api/logout", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Accept": "application/json"
        }
      }).finally(() => {
        localStorage.clear();
        window.location.href = "index.html";
      });
    }

    loadInventory();
  </script>
</body>
</html>
