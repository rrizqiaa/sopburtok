<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- Penting untuk mobile -->
  <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon" />
  <title>Inventory - SOP BURTOK</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="dashboard-wrapper">
    
    <!-- Sidebar -->
    <div class="sidebar">
      <img src="assets/images/Logo Sop Burtok Ori.png" alt="SOP BURTOK" />
      <h3>SOP BURTOK</h3>
      <button class="menu-btn" onclick="location.href='dashboard.html'">Home</button>
      <button class="menu-btn active" onclick="location.href='inventory.html'">Inventory</button>
      <button class="menu-btn" onclick="location.href='production.html'">Production</button>
      <button class="menu-btn" onclick="location.href='reporting.html'">Reporting</button>
      <button class="menu-btn" onclick="location.href='profile.html'">Profile</button>
    </div>

    <!-- Top Tools: jam, darkmode, logout -->
    <div id="top-tools">
    <div id="liveClock" style="font-weight: bold;"></div>
    <button class="toggle-mode-btn" onclick="toggleMode()">üåì</button>
    <button class="logout-btn" onclick="logoutUser()">Logout</button>
  </div>

    <!-- Content -->
    <div class="content">
      <h2>‚ö†Ô∏è Peringatan Bahan Baku</h2>
      <div style="overflow-x:auto">
        <table class="stock-table">
          <thead>
            <tr>
              <th>Nama</th>
              <th>Masalah</th>
            </tr>
          </thead>
          <tbody id="warningTableBody"></tbody>
        </table>
      </div>

       <h2>Inventory Bahan Baku</h2>

<div class="inventory-action-row">
  <button id="btnAddStock" onclick="toggleAddForm()">+ Tambah Bahan Baku</button>
  <input type="file" id="importFile" accept=".csv" onchange="handleImport(event)" />
</div>

<!-- FORM TAMBAH BAHAN -->
<div id="addStockForm" class="hidden">
  <input id="stockName" placeholder="Nama Bahan Baku" />
  <select id="stockCategory">
    <option value="Pokok">Pokok</option>
    <option value="Daging">Daging</option>
    <option value="Sayuran">Sayuran</option>
    <option value="Bumbu">Bumbu</option>
    <option value="Packaging">Packaging</option>
    <option value="Lain - lain">Lain - lain</option>
  </select>
  <input id="stockEntry" type="date" />

  <div class="stock-row">
    <input id="stockAmount" type="number" placeholder="Jumlah" />
    <select id="stockUnit">
      <option value="gr">gr</option>
      <option value="kg">kg</option>
      <option value="ml">ml</option>
      <option value="ltr">ltr</option>
      <option value="pcs">pcs</option>
      <option value="pack">pack</option>
    </select>
  </div>

  <button onclick="addInventory()">Simpan</button>
  <button onclick="hideAddForm()">Batal</button>
</div>

      <div style="overflow-x:auto">
        <table class="stock-table">
          <thead>
            <tr>
              <th>Nama</th>
              <th>Kategori</th>
              <th>Tanggal Masuk</th>
              <th>Jumlah</th>
              <th>Satuan</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="stockTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "index.html";
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    const userRole = user.role || "";

    if (userRole === "staff") {
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("btnAddStock").style.display = "none";
        document.getElementById("addStockForm").style.display = "none";
      });
    }


    function toggleAddForm() {
  const form = document.getElementById("addStockForm");
  form.classList.toggle("hidden");
}

function hideAddForm() {
  document.getElementById("addStockForm").classList.add("hidden");
}

    function updateLiveClock() {
      const el = document.getElementById("liveClock");
      const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
      const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
      const now = new Date();
      el.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()} - ${now.toLocaleTimeString("id-ID")}`;
    }
    setInterval(updateLiveClock, 1000);
    updateLiveClock();

    function toggleMode() {
      const isDark = document.body.classList.toggle("dark-mode");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-mode");
      }
    });

    function logoutUser() {
      fetch("https://api.sopburtok.giize.com/api/logout", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Accept": "application/json"
        }
      }).finally(() => {
        localStorage.clear();
        window.location.href = "index.html";
      });
    }

    function showAddForm() {
      document.getElementById("addStockForm").classList.remove("hidden");
    }

    function hideAddForm() {
      document.getElementById("addStockForm").classList.add("hidden");
    }

    async function loadInventory() {
      try {
        const res = await fetch("https://api.sopburtok.giize.com/api/inventory", {
          headers: { Authorization: `Bearer ${token}`, Accept: "application/json" }
        });
        const data = await res.json();
        renderStockTable(data);
        checkStockAlerts(data);
      } catch (err) {
        console.error("Gagal memuat data:", err);
      }
    }

    function renderStockTable(data) {
      const tbody = document.getElementById("stockTableBody");
      tbody.innerHTML = "";

      data.forEach(item => {
        const row = document.createElement("tr");
        const unit = item.unit || ((item.name?.toLowerCase() === "air" || item.name?.toLowerCase() === "minyak") ? "ml" : "gr");
        const isEditable = userRole !== "staff";

        row.innerHTML = `
          <td>${isEditable ? `<input value="${item.name}" onchange="updateInventory(${item.id}, 'name', this.value)" />` : item.name}</td>
          <td>
            ${isEditable ? `
              <select onchange="updateInventory(${item.id}, 'category', this.value)">
                <option value="Daging" ${item.category === "Daging" ? "selected" : ""}>Daging</option>
                <option value="Sayuran" ${item.category === "Sayuran" ? "selected" : ""}>Sayuran</option>
                <option value="Pokok" ${item.category === "Pokok" ? "selected" : ""}>Pokok</option>
                <option value="Bumbu" ${item.category === "Bumbu" ? "selected" : ""}>Bumbu</option>
                <option value="Packaging" ${item.category === "Packaging" ? "selected" : ""}>Packaging</option>
                <option value="Lain - lain" ${item.category === "Lain - lain" ? "selected" : ""}>Lain - lain</option>
              </select>
            ` : item.category}
          </td>
          <td>${isEditable ? `<input type="date" value="${item.entry_date}" onchange="updateInventory(${item.id}, 'entry_date', this.value)" />` : item.entry_date}</td>
          <td>${isEditable ? `<input type="number" value="${item.stock}" onchange="updateInventory(${item.id}, 'stock', this.value)" style="width: 80px;" />` : item.stock}</td>
          <td>
            ${isEditable ? `
              <select onchange="updateInventory(${item.id}, 'unit', this.value)">
                <option value="gr" ${unit === "gr" ? "selected" : ""}>gr</option>
                <option value="kg" ${unit === "kg" ? "selected" : ""}>kg</option>
                <option value="ml" ${unit === "ml" ? "selected" : ""}>ml</option>
                <option value="ltr" ${unit === "ltr" ? "selected" : ""}>ltr</option>
                <option value="pcs" ${unit === "pcs" ? "selected" : ""}>pcs</option>
                <option value="pack" ${unit === "pack" ? "selected" : ""}>pack</option>
              </select>
            ` : unit}
          </td>
          <td>${isEditable ? `<button onclick="deleteInventory(${item.id})">üóëÔ∏è</button>` : "-"}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function checkStockAlerts(data) {
      const warningTable = document.getElementById("warningTableBody");
      warningTable.innerHTML = "";

      const now = new Date();
      const lowThreshold = 5;

      data.forEach(item => {
        const masalah = [];
        const jumlah = item.stock || 0;

        if (jumlah < lowThreshold) {
          masalah.push(`Stok rendah (${jumlah} ${item.unit || 'gr'})`);
        }

        if (item.entry_date) {
          const entryDate = new Date(item.entry_date);
          const daysStored = Math.floor((now - entryDate) / (1000 * 60 * 60 * 24));
          if (daysStored >= 7) {
            masalah.push(`Tersimpan ${daysStored} hari`);
          }
        }

        if (masalah.length > 0) {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${item.name}</td><td>${masalah.join("<br>")}</td>`;
          warningTable.appendChild(row);
        }
      });
    }

    async function addInventory() {
      const body = {
        name: document.getElementById("stockName").value,
        category: document.getElementById("stockCategory").value,
        entry_date: document.getElementById("stockEntry").value,
        stock: parseFloat(document.getElementById("stockAmount").value),
        unit: document.getElementById("stockUnit").value || "gr"
      };

      const res = await fetch("https://api.sopburtok.giize.com/api/inventory", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
          Accept: "application/json"
        },
        body: JSON.stringify(body)
      });

      if (res.ok) {
        alert("‚úÖ Berhasil ditambahkan");
        hideAddForm();
        loadInventory();
      } else {
        alert("‚ùå Gagal menambahkan data");
      }
    }

    async function updateInventory(id, field, value) {
      await fetch(`https://api.sopburtok.giize.com/api/inventory/${id}`, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
          Accept: "application/json"
        },
        body: JSON.stringify({ [field]: value })
      });
    }

    async function deleteInventory(id) {
      if (!confirm("Hapus bahan baku ini?")) return;
      await fetch(`https://api.sopburtok.giize.com/api/inventory/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}`, Accept: "application/json" }
      });
      loadInventory();
    }

    async function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return alert("‚ùóPilih file CSV terlebih dahulu.");

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async function(results) {
          const data = results.data;
          let success = 0, failed = 0;

          for (const row of data) {
            const payload = {
              name: row.Nama?.trim(),
              category: row.Kategori?.trim() || "Pokok",
              entry_date: formatDate(row.TanggalMasuk),
              stock: parseFloat(row.Jumlah) || 0,
              unit: row.Satuan?.trim() || null
            };

            try {
              const res = await fetch("https://api.sopburtok.giize.com/api/inventory", {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                  Accept: "application/json"
                },
                body: JSON.stringify(payload)
              });
              res.ok ? success++ : failed++;
            } catch {
              failed++;
            }
          }

          alert(`‚úÖ Import selesai:\n‚úîÔ∏è Berhasil: ${success}\n‚ùå Gagal: ${failed}`);
          loadInventory();
        }
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return new Date().toISOString().split("T")[0];
      const parts = dateStr.split(/[\/\-]/);
      if (parts.length === 3) {
        return parts[2].length === 4
          ? `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`
          : dateStr;
      }
      return new Date().toISOString().split("T")[0];
    }

    loadInventory();
  </script>
</body>
</html>