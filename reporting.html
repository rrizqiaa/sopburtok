<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon" />
  <title>Reporting - SOP BURTOK</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Chart.js masih dipakai untuk Pie & Line -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .chart-wrapper {
      position: relative;
      width: 100%;
      padding-top: 100%; /* aspect ratio 1:1 */
    }

    canvas#mainChart {
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
    }

    @media (min-width: 769px) {
      .mobile-bottom-nav {
        display: none !important;
      }
    }

    @media (max-width: 768px) {
      .mobile-bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid #ccc;
        display: flex;
        justify-content: space-around;
        padding: 8px 0;
        z-index: 1000;
      }
      .mobile-bottom-nav button {
        flex: 1;
        background: none;
        border: none;
        font-size: 12px;
      }
    }
    .mobile-bottom-nav button i {
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="dashboard-wrapper">
    <!-- Sidebar, top-tools, dll tetap -->
    <div class="sidebar">
      <img src="assets/images/Logo Sop Burtok Ori.png" alt="SOP BURTOK" />
      <h3>SOP BURTOK</h3>
      <button class="menu-btn" onclick="location.href='dashboard.html'">Home</button>
      <button class="menu-btn" onclick="location.href='inventory.html'">Inventory</button>
      <button class="menu-btn" onclick="location.href='production.html'">Production</button>
      <button class="menu-btn active" onclick="location.href='reporting.html'">Reporting</button>
      <button class="menu-btn" onclick="location.href='profile.html'">Profile</button>
    </div>

    <div id="top-tools">
      <div id="liveClock" style="font-weight: bold;"></div>
      <button class="toggle-mode-btn" onclick="toggleMode()">ðŸŒ“</button>
      <button class="logout-btn" onclick="logoutUser()">Logout</button>
    </div>

    <div class="content">
      <h2>Reporting - Laporan Stok Saat Ini</h2>
      <div class="export-buttons" id="exportButtons">
        <button onclick="exportToPDF()">Export to PDF</button>
        <button onclick="exportTableToCSV()">Export to Excel</button>
      </div>

      <!-- âœ… Mulai area yang akan di-export -->
      <div id="pdfExportArea">
        <div style="margin-bottom: 15px;">
          <label for="chartType">Tipe Grafik:</label>
          <select id="chartType" onchange="updateChartType()">
            <option value="pie">Pie Chart</option>
            <option value="line">Line Chart</option>
          </select>
        </div>

        <div class="chart-wrapper">
          <canvas id="mainChart"></canvas>
        </div>

        <table class="stock-table">
          <thead>
            <tr>
              <th>No</th>
              <th>SKU</th>
              <th>Nama</th>
              <th>Kategori</th>
              <th>Tanggal Masuk</th>
              <th>Jumlah</th>
              <th>Satuan</th>
            </tr>
          </thead>
          <tbody id="reportingTableBody"></tbody>
        </table>
      </div>

      <!-- Log Aktivitas tidak termasuk dalam PDF -->
      <h2 style="margin-top: 50px;">Log Aktivitas</h2>
      <table class="stock-table">
        <thead>
          <tr>
            <th>Judul Laporan</th>
            <th>Isi</th>
            <th>Tanggal</th>
            <th>Sumber</th>
          </tr>
        </thead>
        <tbody id="logTableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="mobile-bottom-nav">
    <button onclick="location.href='dashboard.html'"><i class="fas fa-home"></i></button>
    <button onclick="location.href='inventory.html'"><i class="fas fa-box"></i></button>
    <button onclick="location.href='production.html'"><i class="fas fa-industry"></i></button>
    <button class="active" onclick="location.href='reporting.html'"><i class="fas fa-chart-bar"></i></button>
    <button onclick="location.href='profile.html'"><i class="fas fa-user"></i></button>
  </div>

<script>
const API_BASE = 'https://api.sopburtok.giize.com/api';
const token = localStorage.getItem('token');
if (!token) location.href = 'index.html';
const user = JSON.parse(localStorage.getItem("user") || "{}");
const userRole = user.role || "";

// ---------- Variabel chart ----------
let chartInstance = null;
let currentChartType = "pie"; // default sekarang pie
let currentChartLabels = [];
let currentChartData = [];
let currentLineLabels = [];
let currentLineDatasets = {};

async function loadReports() {
  try {
    const res = await fetch(`${API_BASE}/inventory`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/json'
      }
    });
    const data = await res.json();

    const tbody = document.getElementById('reportingTableBody');
    tbody.innerHTML = '';

    // ------ Kategori yang sama dengan Inventory ------
    const kategoriList = [
      "Pokok",
      "Daging",
      "Sayuran",
      "Bumbu",
      "Packaging",
      "Lain - lain"
    ];
    const kategoriMap = Object.fromEntries(kategoriList.map(k => [k, 0]));
    const trendMap = {}; // { 'Jan 2025': {Pokok:0, ...}, ... }

    data.forEach((item, index) => {
      // ---- Tabel ----
      const satuan = item.unit || 'gr';
      const jumlahDisplay = (satuan === 'kg' || satuan === 'ltr') ? (item.stock / 1000).toFixed(2) : item.stock;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${item.sku || '-'}</td>
        <td>${item.name}</td>
        <td>${item.category}</td>
        <td>${item.entry_date}</td>
        <td>${jumlahDisplay}</td>
        <td>${satuan}</td>`;
      tbody.appendChild(tr);

      // ---- Pie data ----
      if (kategoriMap[item.category] !== undefined) {
        kategoriMap[item.category] += item.stock;
      }

      // ---- Line data (tren per bulan) ----
      const bulan = new Date(item.entry_date).toLocaleString('id-ID', { month: 'short', year: 'numeric' });
      if (!trendMap[bulan]) {
        trendMap[bulan] = Object.fromEntries(kategoriList.map(k => [k, 0]));
      }
      if (trendMap[bulan][item.category] !== undefined) {
        trendMap[bulan][item.category] += item.stock;
      }
    });

    // ------ Siapkan data chart ------
    currentChartLabels = kategoriList;
    currentChartData   = kategoriList.map(k => kategoriMap[k]);

// --- Ganti blok lama ini -----------------------------
// const monthLabels = Object.keys(trendMap)
//   .sort((a, b) => new Date("01 " + a) - new Date("01 " + b));

// --- Dengan blok baru di bawah -----------------------
const monthLabels = Object.keys(trendMap).sort((a, b) => {
  const parse = (str) => {
    const [mon, yr] = str.split(" ");
    const idMonths = [
      "Jan","Feb","Mar","Apr","Mei","Jun",
      "Jul","Agu","Sep","Okt","Nov","Des"
    ];
    return new Date(+yr, idMonths.indexOf(mon));
  };
  return parse(a) - parse(b);   // April â†’ Mei â†’ dst.
});
    currentLineLabels = monthLabels;
    currentLineDatasets = {};
    kategoriList.forEach(kat => {
      currentLineDatasets[kat] = monthLabels.map(bln => trendMap[bln][kat] || 0);
    });

    updateChart();
  } catch (err) {
    console.error('Gagal memuat laporan:', err);
    document.getElementById('reportingTableBody').innerHTML = '<tr><td colspan="7">Gagal memuat data.</td></tr>';
  }
}

function updateChartType() {
  currentChartType = document.getElementById("chartType").value;
  updateChart();
}

    function updateChart() {
      const canvas = document.getElementById("mainChart");
      const ctx = canvas.getContext("2d");
      if (chartInstance) chartInstance.destroy();

      const options = {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          datalabels: {
            formatter: (value, ctx) => {
              const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              const percentage = (value * 100 / sum).toFixed(1) + "%";
              return percentage;
            },
            color: '#000',
            font: { weight: 'bold' },
            clip: false,
            padding: 6
          }
        }
      };

      if (currentChartType === "pie") {
        chartInstance = new Chart(ctx, {
          type: "pie",
          data: {
            labels: currentChartLabels,
            datasets: [{
              data: currentChartData,
              backgroundColor: currentChartLabels.map((_, i) => `hsl(${i * 60}, 70%, 60%)`)
            }]
          },
          options,
          plugins: [ChartDataLabels]
        });
      } else if (currentChartType === "line") {
        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: currentLineLabels,
            datasets: currentChartLabels.map((label, i) => ({
              label,
              data: currentLineDatasets[label],
              borderColor: `hsl(${i * 60}, 70%, 50%)`,
              fill: false,
              tension: 0.3
            }))
          },
          options
        });
      }
    }
    
    function logoutUser() {
      fetch(`${API_BASE}/logout`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}`, "Accept": "application/json" }
      }).finally(() => {
        localStorage.clear();
        window.location.href = "index.html";
      });
    }

// ... (fungsi exportTableToCSV, exportToPDF, loadActivityLogs, logExportActivity, updateLiveClock, toggleMode sama seperti semula) ...

async function loadActivityLogs() {
  try {
    const res = await fetch(`${API_BASE}/activity-log`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const logs = await res.json();

    const tbody = document.getElementById("logTableBody");
    tbody.innerHTML = '';

    logs.forEach(log => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${log.document_title}</td>
        <td>${log.action}</td>
        <td>${new Date(log.created_at).toLocaleString('id-ID')}</td>
        <td>${log.name}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error('Gagal memuat log aktivitas:', err);
    document.getElementById("logTableBody").innerHTML =
      `<tr><td colspan="4">Gagal memuat log aktivitas.</td></tr>`;
  }
}

function exportTableToCSV() {
  const table = document.querySelector('.stock-table');
  const rows = table.querySelectorAll('tr');
  let csv = [];

  rows.forEach(row => {
    let cols = row.querySelectorAll('th, td');
    let rowData = Array.from(cols).map(col => `"${col.innerText.trim()}"`).join(',');
    csv.push(rowData);
  });

  const csvString = csv.join('\n');
  const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const username = (user.name || "pengguna").replace(/\s+/g, "_");
  const today = new Date().toISOString().slice(0, 10);
  const filename = `laporan_stok_${username}_${today}.csv`;

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  logExportActivity(`Export Excel - ${filename}`);
}

function exportToPDF() {
  const area = document.getElementById("pdfExportArea");

  html2canvas(area, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jspdf.jsPDF({
      orientation: "portrait",
      unit: "mm",
      format: "a4"
    });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth - 20;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let y = 10;
    if (imgHeight > pageHeight - 20) {
      pdf.addImage(imgData, "PNG", 10, y, imgWidth, pageHeight - 20);
      pdf.addPage();
      pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
    } else {
      pdf.addImage(imgData, "PNG", 10, y, imgWidth, imgHeight);
    }

    const username = (user.name || "pengguna").replace(/\s+/g, "_");
    const today = new Date().toISOString().slice(0, 10);
    const filename = `laporan_stok_${username}_${today}.pdf`;
    pdf.save(filename);
    logExportActivity(`Export PDF - ${filename}`);
  });
}

function logExportActivity(judulLaporan) {
  fetch(`${API_BASE}/activity-log`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ document_title: judulLaporan })
  })
  .then(res => res.json())
  .then(data => {
    console.log('Log aktivitas tercatat:', data.message);
  })
  .catch(err => {
    console.error('Gagal mencatat log aktivitas:', err);
  });
}

  function updateLiveClock() {
    const clockElement = document.getElementById('liveClock');
    const now = new Date();
    const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
    const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
    clockElement.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()} - ${now.toLocaleTimeString('id-ID')}`;
  }

    function toggleMode() {
    const isDark = document.body.classList.toggle("dark-mode");
    localStorage.setItem("theme", isDark ? "dark" : "light");
  }
  
// ---------- Init ----------
document.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark-mode");
  if (userRole === "staff") document.getElementById("exportButtons").style.display = "none";
  loadReports();
  loadActivityLogs();
  updateLiveClock();
  setInterval(updateLiveClock, 1000);
});
</script>


</body>
</html>
