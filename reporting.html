<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon" />
  <title>Reporting - SOP BURTOK</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    canvas#mainChart {
      max-width: 100%;
      height: auto;
      margin-bottom: 30px;
    }

    .export-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .export-buttons button {
      padding: 10px 15px;
      background-color: #3498db;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .export-buttons button:hover {
      background-color: #2980b9;
    }

    @media (max-width: 768px) {
      .dashboard-wrapper {
        flex-direction: column;
      }

      .sidebar {
        position: static !important;
        width: 100% !important;
        height: auto;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
        padding: 10px 0;
      }

      .sidebar img,
      .sidebar h3 {
        display: none;
      }

      .menu-btn {
        flex: 1;
        text-align: center;
        font-size: 12px;
        padding: 10px 0;
      }

      #top-tools {
        position: static !important;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 10px;
        background-color: #f0f0f0;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      #top-tools #liveClock {
        font-size: 13px;
        text-align: center;
      }

      .toggle-mode-btn,
      .logout-btn {
        font-size: 18px;
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
      }

      .logout-btn {
        color: #e74c3c;
      }

      .content {
        margin-left: 0 !important;
        width: 100% !important;
        padding: 20px !important;
        box-sizing: border-box;
      }

      table.stock-table {
        font-size: 13px;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      select#chartType {
        width: 100%;
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
<div class="dashboard-wrapper">
  <div class="sidebar">
    <img src="assets/images/Logo Sop Burtok Ori.png" alt="SOP BURTOK" />
    <h3>SOP BURTOK</h3>
    <button class="menu-btn" onclick="location.href='dashboard.html'">Home</button>
    <button class="menu-btn" onclick="location.href='inventory.html'">Inventory</button>
    <button class="menu-btn" onclick="location.href='production.html'">Production</button>
    <button class="menu-btn active" onclick="location.href='reporting.html'">Reporting</button>
    <button class="menu-btn" onclick="location.href='profile.html'">Profile</button>
  </div>

  <div id="top-tools">
    <div id="liveClock" style="font-weight: bold;"></div>
    <button class="toggle-mode-btn" onclick="toggleMode()">ðŸŒ“</button>
    <button class="logout-btn" onclick="logoutUser()">Logout</button>
  </div>

 <div class="content">
  <h2>Reporting - Laporan Stok Saat Ini</h2>
  <div class="export-buttons" id="exportButtons">
    <button onclick="exportToPDF()">Export to PDF</button>
    <button onclick="exportTableToCSV()">Export to Excel</button>
  </div>

  <!-- âœ… Mulai area yang akan di-export -->
  <div id="pdfExportArea">
    <div style="margin-bottom: 15px;">
      <label for="chartType">Tipe Grafik:</label>
      <select id="chartType" onchange="updateChartType()">
        <option value="bar">Bar Chart</option>
        <option value="pie">Pie Chart</option>
        <option value="line">Line Chart</option>
      </select>
    </div>

    <canvas id="mainChart" width="800" height="450"></canvas>

    <table class="stock-table">
      <thead>
        <tr>
          <th>Nama</th>
          <th>Kategori</th>
          <th>Tanggal Masuk</th>
          <th>Jumlah Tersedia</th>
        </tr>
      </thead>
      <tbody id="reportingTableBody"></tbody>
    </table>
  </div>
  <!-- âœ… Tutup area export PDF -->

  <!-- Log Aktivitas tidak termasuk dalam PDF -->
  <h2 style="margin-top: 50px;">Log Aktivitas</h2>
  <table class="stock-table">
    <thead>
      <tr>
        <th>Judul Laporan</th>
        <th>Isi</th>
        <th>Tanggal</th>
        <th>Sumber</th>
      </tr>
    </thead>
    <tbody id="logTableBody"></tbody>
  </table>
</div>

</div>

<script>
const API_BASE = 'https://api.sopburtok.giize.com/api';
const token = localStorage.getItem('token');
if (!token) location.href = 'index.html';
const user = JSON.parse(localStorage.getItem("user") || "{}");
const userRole = user.role || "";

let chartInstance = null;
let currentChartType = "bar";
let currentChartLabels = [];
let currentChartData = [];
let currentLineLabels = [];
let currentLineDatasets = {};

async function loadReports() {
  try {
    const res = await fetch(`${API_BASE}/inventory`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/json'
      }
    });
    const data = await res.json();

    const tbody = document.getElementById('reportingTableBody');
    tbody.innerHTML = '';

    const kategoriMap = { Pokok: 0, Sayuran: 0, Bumbu: 0 };
    const trendMap = {};

    data.forEach(item => {
      const kategori = item.category?.toLowerCase();
      if (kategori === "pokok") kategoriMap.Pokok += item.stock;
      else if (kategori === "sayuran") kategoriMap.Sayuran += item.stock;
      else if (kategori === "bumbu") kategoriMap.Bumbu += item.stock;

      const bulan = new Date(item.entry_date).toLocaleString('id-ID', { month: 'short', year: 'numeric' });
      if (!trendMap[bulan]) trendMap[bulan] = { Pokok: 0, Sayuran: 0, Bumbu: 0 };
      if (kategori === "pokok") trendMap[bulan].Pokok += item.stock;
      else if (kategori === "sayuran") trendMap[bulan].Sayuran += item.stock;
      else if (kategori === "bumbu") trendMap[bulan].Bumbu += item.stock;

      let satuan = 'kg';
      const namaLower = item.name.toLowerCase();
      if (namaLower.includes('air') || namaLower.includes('minyak')) satuan = 'liter';

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${item.name}</td><td>${item.category}</td><td>${item.entry_date}</td><td>${item.stock} ${satuan}</td>`;
      tbody.appendChild(tr);
    });

    currentChartLabels = ["Pokok", "Sayuran", "Bumbu"];
    currentChartData = [kategoriMap.Pokok, kategoriMap.Sayuran, kategoriMap.Bumbu];

    const monthLabels = Object.keys(trendMap).sort((a, b) => new Date("01 " + a) - new Date("01 " + b));
    currentLineLabels = monthLabels;
    currentLineDatasets = {
      Pokok: monthLabels.map(bln => trendMap[bln].Pokok),
      Sayuran: monthLabels.map(bln => trendMap[bln].Sayuran),
      Bumbu: monthLabels.map(bln => trendMap[bln].Bumbu)
    };

    updateChart();
  } catch (err) {
    console.error('Gagal memuat laporan:', err);
    document.getElementById('reportingTableBody').innerHTML = '<tr><td colspan="4">Gagal memuat data.</td></tr>';
  }
}

function updateChartType() {
  currentChartType = document.getElementById("chartType").value;
  updateChart();
}

function logoutUser() {
      fetch("https://api.sopburtok.giize.com/api/logout", {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}`, "Accept": "application/json" }
      }).finally(() => {
        localStorage.clear();
        window.location.href = "index.html";
      });
    }

function updateChart() {
  const canvas = document.getElementById("mainChart");
  const ctx = canvas.getContext("2d");

  if (chartInstance) chartInstance.destroy();

  if (currentChartType === "bar") {
    chartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels: currentChartLabels,
        datasets: [{
          label: "Jumlah Stok",
          data: currentChartData,
          backgroundColor: "rgba(75, 192, 192, 0.6)"
        }]
      },
      options: { responsive: false }
    });
  } else if (currentChartType === "pie") {
    chartInstance = new Chart(ctx, {
      type: "pie",
      data: {
        labels: currentChartLabels,
        datasets: [{
          data: currentChartData,
          backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)']
        }]
      },
      options: { responsive: false }
    });
  } else if (currentChartType === "line") {
    chartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels: currentLineLabels,
        datasets: [
          { label: "Pokok", data: currentLineDatasets.Pokok, borderColor: "rgba(255, 99, 132, 1)", fill: false },
          { label: "Sayuran", data: currentLineDatasets.Sayuran, borderColor: "rgba(54, 162, 235, 1)", fill: false },
          { label: "Bumbu", data: currentLineDatasets.Bumbu, borderColor: "rgba(255, 206, 86, 1)", fill: false }
        ]
      },
      options: { responsive: false }
    });
  }
}

function logout() {
  fetch(`${API_BASE}/logout`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/json'
    }
  }).finally(() => {
    localStorage.removeItem('token');
    location.href = "index.html";
  });
}

function exportTableToCSV() {
  const table = document.querySelector('.stock-table');
  const rows = table.querySelectorAll('tr');
  let csv = [];

  rows.forEach(row => {
    let cols = row.querySelectorAll('th, td');
    let rowData = Array.from(cols).map(col => `"${col.innerText.trim()}"`).join(',');
    csv.push(rowData);
  });

  const csvString = csv.join('\n');
  const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const username = (user.name || "pengguna").replace(/\s+/g, "_");
  const today = new Date().toISOString().slice(0, 10);
  const filename = `laporan_stok_${username}_${today}.csv`;

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function exportToPDF() {
  const area = document.getElementById("pdfExportArea");

  html2canvas(area, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jspdf.jsPDF({
      orientation: "portrait",
      unit: "mm",
      format: "a4"
    });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth - 20;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let y = 10;
    if (imgHeight > pageHeight - 20) {
      // jika melebihi satu halaman
      pdf.addImage(imgData, "PNG", 10, y, imgWidth, pageHeight - 20);
      pdf.addPage();
      pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
    } else {
      pdf.addImage(imgData, "PNG", 10, y, imgWidth, imgHeight);
    }

    const username = (user.name || "pengguna").replace(/\s+/g, "_");
    const today = new Date().toISOString().slice(0, 10);
    const filename = `laporan_stok_${username}_${today}.pdf`;
    pdf.save(filename);

  });
}


function updateLiveClock() {
  const el = document.getElementById('liveClock');
  const now = new Date();
  const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  el.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()} - ${now.toLocaleTimeString('id-ID')}`;
}

function toggleMode() {
  const isDark = document.body.classList.toggle("dark-mode");
  localStorage.setItem("theme", isDark ? "dark" : "light");
}

document.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark-mode");
  if (userRole === "staff") document.getElementById("exportButtons").style.display = "none";
  loadReports();
  updateLiveClock();
  setInterval(updateLiveClock, 1000);
});
</script>
</body>
</html>