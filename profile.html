<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Profile - SOP BURTOK</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <style>
    .profile-content-flex {
      display: flex;
      gap: 40px;
      justify-content: space-between;
      align-items: flex-start;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .equal-box {
      flex: 1;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      min-width: 300px;
      box-sizing: border-box;
    }

    .equal-box h2 {
      margin: 0 0 16px 0;
    }

    .star {
      cursor: pointer;
      color: #ccc;
    }
    .star.selected {
      color: gold;
    }

    @media (max-width: 768px) {
      .profile-content-flex {
        flex-direction: column;
      }
    }
  </style></head>
<body>
<div class="dashboard-wrapper">
  <div class="sidebar">
    <img src="assets\images\Logo Sop Burtok Ori.png" alt="SOP BURTOK">
    <h3>SOP BURTOK</h3>
    <button class="menu-btn" onclick="location.href='dashboard.html'">Home</button>
    <button class="menu-btn" onclick="location.href='inventory.html'">Inventory</button>
    <button class="menu-btn" onclick="location.href='production.html'">Production</button>
    <button class="menu-btn" onclick="location.href='reporting.html'">Reporting</button>
    <button class="menu-btn active" onclick="location.href='profile.html'">Profile</button>
  </div>

  <div class="top-bar">
    <div id="liveClock" style="margin-right: 15px; font-weight: bold;"></div>
    <button class="toggle-mode-btn" onclick="toggleMode()" style="margin-right: 10px;">üåì</button>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="content">
<div class="profile-content-flex">
  <div class="profile-info" style="flex: 1; margin-right: 20px;">
    <h2>Halaman Profile</h2>
    <label>Nama</label>
    <input id="nama" type="text" placeholder="Nama Anda">

    <label>Email</label>
    <input id="email" type="text" disabled>

    <label>No. HP</label>
    <input id="hp" type="text" placeholder="08xxxxxxxx">

    <label>Alamat</label>
    <input id="alamat" type="text" placeholder="Alamat lengkap">

    <button onclick="updateProfile()">Update</button>
  </div>
    <hr style="margin: 40px 0;">

  <div class="logbook-section" style="flex: 1;">
    <h2>Logbook</h2>

    <label for="log-comment">Komentar</label>
    <textarea id="log-comment" placeholder="Tulis komentar..." rows="3" style="width: 100%;"></textarea>

    <label for="log-rating">Rating</label>
    <div id="log-rating" style="font-size: 24px; margin-bottom: 10px;">
      ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
    </div>

    <button onclick="addLogEntry()">Tambah Log</button>

    <h3 style="margin-top: 30px;">Riwayat Logbook</h3>
    <div id="logbook-entries"></div>
  </div>
</div>

      
      <!-- Admin-only section -->
      <div id="admin-section" style="display: none; margin-top: 40px;">
        <button onclick="toggleForm()" style="margin-bottom: 10px;">+ Tambah Akun Baru</button>

        <div id="formBuatUser" style="display: none; border: 1px solid #ccc; padding: 15px;">
          <h3>Buat Akun Baru</h3>
          <input id="new_name" type="text" placeholder="Nama Lengkap"><br>
          <input id="new_email" type="email" placeholder="Email"><br>
          <input id="new_password" type="password" placeholder="Password"><br>
          <input id="new_hp" type="text" placeholder="No HP (opsional)"><br>
          <input id="new_alamat" type="text" placeholder="Alamat (opsional)"><br>
          <select id="new_role">
            <option value="staff">Staf</option>
            <option value="admin">Admin</option>
          </select><br>
          <button onclick="createUser()">Buat Akun</button>
        </div>

        <button onclick="toggleUserList()" style="margin-top: 20px;">üë• Lihat Daftar Akun</button>

        <div id="userListSection" style="display: none; margin-top: 15px;">
          <h3>Daftar Akun Terdaftar</h3>
          <div id="userListContainer"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://api.sopburtok.giize.com/api';
const token = localStorage.getItem('token');
if (!token) location.href = 'index.html';

document.addEventListener('DOMContentLoaded', () => {
  if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark-mode');
  }

  fetchProfile();
  updateLiveClock();
  setInterval(updateLiveClock, 1000);
});

function fetchProfile() {
  fetch(`${API_BASE}/user-profile`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(user => {
    document.getElementById('nama').value = user.name || '';
    document.getElementById('email').value = user.email || '';
    document.getElementById('hp').value = user.phone || '';
    document.getElementById('alamat').value = user.address || '';

    if (user.role === 'admin') {
      document.getElementById('admin-section').style.display = 'block';
    }
  })
  .catch(() => alert('Gagal mengambil data profil'));
}

function updateProfile() {
  const data = {
    name: document.getElementById('nama').value,
    phone: document.getElementById('hp').value,
    address: document.getElementById('alamat').value
  };

  fetch(`${API_BASE}/user-profile`, {
    method: 'PUT',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(response => {
    alert(response.message || 'Profil berhasil diperbarui');
  })
  .catch(() => alert('Terjadi kesalahan saat memperbarui profil'));
}

function toggleForm() {
  const form = document.getElementById('formBuatUser');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function createUser() {
  const name = document.getElementById('new_name').value;
  const email = document.getElementById('new_email').value;
  const password = document.getElementById('new_password').value;

  if (!name || !email || !password) {
    alert('Nama, email dan password wajib diisi');
    return;
  }

  const data = {
    name,
    email,
    password,
    phone: document.getElementById('new_hp').value,
    address: document.getElementById('new_alamat').value,
    role: document.getElementById('new_role').value
  };

  fetch(`${API_BASE}/users`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(async res => {
    const json = await res.json();
    if (!res.ok) throw new Error(json.message || 'Gagal membuat akun');

    alert(json.message || 'Akun berhasil dibuat');

    // ‚úÖ Reset form tambah user
    document.getElementById('new_name').value = '';
    document.getElementById('new_email').value = '';
    document.getElementById('new_password').value = '';
    document.getElementById('new_hp').value = '';
    document.getElementById('new_alamat').value = '';
    document.getElementById('new_role').value = 'staff';

    fetchUserList(); // ‚¨ÖÔ∏è hanya refresh daftar, bukan profile
  })
  .catch(err => alert(err.message));
}


function toggleUserList() {
  const section = document.getElementById('userListSection');
  if (section.style.display === 'none') {
    section.style.display = 'block';
    fetchUserList();
  } else {
    section.style.display = 'none';
  }
}

function fetchUserList() {
  fetch(`${API_BASE}/users`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(users => {
    const container = document.getElementById('userListContainer');
    container.innerHTML = '';

    if (!Array.isArray(users)) {
      alert('Format data user tidak sesuai');
      return;
    }

    if (users.length === 0) {
      container.innerHTML = '<p><em>Tidak ada user terdaftar.</em></p>';
      return;
    }

    users.forEach(user => {
      const div = document.createElement('div');
      div.classList.add('user-row');
      div.style.padding = '6px';
      div.style.borderBottom = '1px solid #eee';
      div.innerHTML = `
        <span><strong>${user.name}</strong> (${user.email}) - ${user.role}</span>
        <button style="float:right;" onclick="deleteUser(${user.id})">üóëÔ∏è</button>
      `;
      container.appendChild(div);
    });
  })
  .catch(() => alert('Gagal memuat daftar user'));
}

function deleteUser(userId) {
  if (!confirm('Yakin ingin menghapus akun ini?')) return;

  fetch(`${API_BASE}/users/${userId}`, {
    method: 'DELETE',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => {
    if (res.ok) {
      alert('User berhasil dihapus');
      fetchUserList();
    } else {
      return res.json().then(json => {
        throw new Error(json.message || 'Gagal menghapus user');
      });
    }
  })
  .catch(err => alert(err.message));
}

function logout() {
  fetch(`${API_BASE}/logout`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  }).finally(() => {
    localStorage.removeItem('token');
    location.href = "index.html";
  });
}

function updateLiveClock() {
  const clockElement = document.getElementById('liveClock');
  if (!clockElement) return;

  const now = new Date();
  const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];

  clockElement.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()} - ${now.toLocaleTimeString('id-ID')}`;
}

function toggleMode() {
  const isDark = document.body.classList.toggle("dark-mode");
  localStorage.setItem("theme", isDark ? "dark" : "light");
}

// Inisialisasi saat halaman dimuat
document.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
  }
});

function setupRatingStars() {
  const ratingContainer = document.getElementById('log-rating');
  ratingContainer.innerHTML = '';
  for (let i = 1; i <= 5; i++) {
    const star = document.createElement('span');
    star.classList.add('star');
    star.innerHTML = '‚òÖ';
    star.dataset.value = i;
    star.onclick = () => setRating(i);
    stars.push(star);
    ratingContainer.appendChild(star);
  }
}

function setRating(value) {
  selectedRating = value;
  stars.forEach((star, i) => {
    if (i < value) {
      star.classList.add('selected');
    } else {
      star.classList.remove('selected');
    }
  });
}

function addLogEntry() {
  const comment = document.getElementById('log-comment').value.trim();
  if (!comment || selectedRating === 0) {
    alert('Komentar dan rating harus diisi.');
    return;
  }

const logEntry = {
  timestamp: new Date().toLocaleString('id-ID'),
  comment,
  rating: selectedRating,
  user: document.getElementById('nama')?.value || 'Tidak diketahui'
};

  const logs = JSON.parse(localStorage.getItem('logbook') || '[]');
  logs.unshift(logEntry);
  localStorage.setItem('logbook', JSON.stringify(logs));

  document.getElementById('log-comment').value = '';
  setRating(0);
  renderLogbook();
}

function renderLogbook() {
  const container = document.getElementById('logbook-entries');
  container.innerHTML = '';

  let logs = JSON.parse(localStorage.getItem('logbook') || '[]');

  // Filter log yang valid saja
  logs = logs.filter(entry => entry.user !== undefined && entry.user !== null);

  // Simpan ulang ke localStorage (bersihkan yang tidak valid)
  localStorage.setItem('logbook', JSON.stringify(logs));

  if (logs.length === 0) {
    container.innerHTML = '<p><em>Belum ada entri logbook.</em></p>';
    return;
  }

  logs.forEach(entry => {
    const div = document.createElement('div');
    div.style.borderBottom = '1px solid #ccc';
    div.style.padding = '8px 0';
    div.innerHTML = `
      <div><strong>${entry.timestamp}</strong> - <em>${entry.user}</em></div>
      <div>${'‚òÖ'.repeat(entry.rating)}${'‚òÜ'.repeat(5 - entry.rating)}</div>
      <div>${entry.comment}</div>
    `;
    container.appendChild(div);
  });
}

</script>

</body>
</html>
