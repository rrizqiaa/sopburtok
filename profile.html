<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile - SOP BURTOK</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon" />

  <style>
    .profile-info {
  background-color: #f9f9f9;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.profile-info label {
  display: block;
  margin-top: 12px;
  font-weight: 500;
}

.profile-info input {
  width: 100%;
  padding: 8px 10px;
  font-size: 14px;
  margin-top: 5px;
  border: 1px solid #ccc;
  border-radius: 5px;
  box-sizing: border-box;
}

.profile-info button {
  margin-top: 15px;
  padding: 10px 15px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.profile-info button:hover {
  background-color: #0056b3;
}

    .profile-content-flex {
      display: flex;
      gap: 40px;
      justify-content: space-between;
      align-items: flex-start;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .equal-box {
      flex: 1;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      min-width: 300px;
      box-sizing: border-box;
    }

    .equal-box h2 {
      margin: 0 0 16px 0;
    }

    .star {
      cursor: pointer;
      color: #ccc;
    }
    .star.selected {
      color: gold;
    }

    @media (max-width: 768px) {
      .profile-content-flex {
        flex-direction: column;
      }
    }


    .profile-info,
    .logbook-section {
      flex: 1;
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    @media (max-width: 768px) {
      .dashboard-wrapper {
        flex-direction: column;
      }

      .sidebar {
        position: static !important;
        width: 100% !important;
        height: auto;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
        padding: 10px 0;
      }

      .sidebar img,
      .sidebar h3 {
        display: none;
      }

      .menu-btn {
        flex: 1;
        text-align: center;
        font-size: 12px;
        padding: 10px 0;
      }

      #top-tools {
        position: static !important;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 10px;
        background-color: #f0f0f0;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .content {
        margin-left: 0 !important;
        width: 100% !important;
        padding: 20px !important;
        box-sizing: border-box;
      }

      .profile-content-flex {
        flex-direction: column;
      }

      .profile-info,
      .logbook-section {
        width: 100%;
      }

      input,
      textarea,
      select,
      button {
        width: 100%;
        margin-bottom: 10px;
      }
    }
    .logbook-section label {
  display: block;
  margin-top: 12px;
  font-weight: 500;
}

.logbook-section textarea {
  width: 100%;
  padding: 8px 10px;
  font-size: 14px;
  margin-top: 5px;
  border: 1px solid #ccc;
  border-radius: 5px;
  box-sizing: border-box;
}

.logbook-section button {
  margin-top: 15px;
  padding: 10px 15px;
  background-color: #28a745;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.logbook-section button:hover {
  background-color: #218838;
}

#logbook-entries {
  margin-top: 15px;
}

#logbook-entries div {
  border-bottom: 1px solid #ddd;
  padding: 8px 0;
}

#log-rating {
  font-size: 24px;
  margin-top: 5px;
}

#log-rating .star {
  margin-right: 5px;
}

  </style>
</head>
<body>
  <div class="dashboard-wrapper">
    <div class="sidebar">
      <img src="assets/images/Logo Sop Burtok Ori.png" alt="SOP BURTOK" />
      <h3>SOP BURTOK</h3>
      <button class="menu-btn" onclick="location.href='dashboard.html'">Home</button>
      <button class="menu-btn" onclick="location.href='inventory.html'">Inventory</button>
      <button class="menu-btn" onclick="location.href='production.html'">Production</button>
      <button class="menu-btn" onclick="location.href='reporting.html'">Reporting</button>
      <button class="menu-btn active" onclick="location.href='profile.html'">Profile</button>
    </div>

    <div id="top-tools">
      <div id="liveClock" style="font-weight: bold;"></div>
      <button class="toggle-mode-btn" onclick="toggleMode()">🌓</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="content">
      <div class="profile-content-flex">
        <!-- Kolom Profil -->
      <div class="profile-info">
        <h2>Halaman Profile</h2>

        <label>Nama Lengkap</label>
        <input id="nama" type="text" placeholder="Nama Lengkap">

        <label>Email</label>
        <input id="email" type="text" disabled placeholder="Email">

        <label>No. HP</label>
        <input id="hp" type="text" placeholder="08xxxxxxxx">

        <label>Alamat</label>
        <input id="alamat" type="text" placeholder="Alamat lengkap">

        <button onclick="updateProfile()">Update</button>
      </div>


        <!-- Kolom Logbook -->
      <div class="logbook-section">
        <h2>Logbook</h2>

        <label for="log-comment">Komentar</label>
        <textarea id="log-comment" rows="3" placeholder="Tulis komentar..."></textarea>

        <label for="log-rating">Rating</label>
        <div id="log-rating" class="rating-stars">★★★★★</div>

        <button onclick="addLogEntry()">Tambah Log</button>

        <h3>Riwayat Logbook</h3>
        <div id="logbook-entries"><em>Belum ada entri logbook.</em></div>
      </div>
      </div>

      <!-- Admin Section -->
      <div id="admin-section" style="display: none; margin-top: 40px;">
        <button onclick="toggleForm()">+ Tambah Akun Baru</button>

        <div id="formBuatUser" style="display: none; border: 1px solid #ccc; padding: 15px; margin-top: 10px;">
          <h3>Buat Akun Baru</h3>
          <input id="new_name" type="text" placeholder="Nama Lengkap" >
          <input id="new_email" type="email" placeholder="Email" >
          <input id="new_password" type="password" placeholder="Password" >
          <input id="new_hp" type="text" placeholder="No HP (opsional)" >
          <input id="new_alamat" type="text" placeholder="Alamat (opsional)" >
          <select id="new_role">
            <option value="admin">Admin</option>
            <option value="manager">Manager</option>
            <option value="staff">Staf</option>
          </select>
          <button onclick="createUser()">Buat Akun</button>
        </div>

        <button onclick="toggleUserList()" style="margin-top: 15px;">👥 Lihat Daftar Akun</button>
        <div id="userListSection" style="display: none; margin-top: 15px;">
          <h3>Daftar Akun Terdaftar</h3>
          <div id="userListContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://api.sopburtok.giize.com/api';
    const token = localStorage.getItem('token');
    if (!token) location.href = 'index.html';

    let selectedRating = 0;
    let stars = [];

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
      }
      fetchProfile();
      setupRatingStars();
      renderLogbook();
      updateLiveClock();
      setInterval(updateLiveClock, 1000);
    });

    function fetchProfile() {
      fetch(`${API_BASE}/user-profile`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
        .then(res => res.json())
        .then(user => {
          document.getElementById('nama').value = user.name || '';
          document.getElementById('email').value = user.email || '';
          document.getElementById('hp').value = user.phone || '';
          document.getElementById('alamat').value = user.address || '';
          if (user.role === 'admin') {
            document.getElementById('admin-section').style.display = 'block';
          }
        })
        .catch(() => alert('Gagal mengambil data profil'));
    }

    function updateProfile() {
      const data = {
        name: document.getElementById('nama').value,
        phone: document.getElementById('hp').value,
        address: document.getElementById('alamat').value
      };

      fetch(`${API_BASE}/user-profile`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(response => alert(response.message || 'Profil berhasil diperbarui'))
        .catch(() => alert('Terjadi kesalahan saat memperbarui profil'));
    }

      function setupRatingStars() {
        const ratingContainer = document.getElementById('log-rating');
        ratingContainer.innerHTML = '';
        stars = [];

        for (let i = 1; i <= 5; i++) {
          const star = document.createElement('span');
          star.innerHTML = '★';
          star.dataset.value = i;
          star.onclick = () => setRating(i);
          stars.push(star);
          ratingContainer.appendChild(star);
        }
      }

      function setRating(value) {
        selectedRating = value;
        stars.forEach((star, i) => {
          star.classList.toggle('selected', i < value);
        });
      }

    function addLogEntry() {
      const comment = document.getElementById('log-comment').value.trim();
      if (!comment || selectedRating === 0) {
        alert('Komentar dan rating harus diisi.');
        return;
      }

      const logEntry = {
        timestamp: new Date().toLocaleString('id-ID'),
        comment,
        rating: selectedRating,
        user: document.getElementById('nama')?.value || 'Tidak diketahui'
      };

      const logs = JSON.parse(localStorage.getItem('logbook') || '[]');
      logs.unshift(logEntry);
      localStorage.setItem('logbook', JSON.stringify(logs));

      document.getElementById('log-comment').value = '';
      setRating(0);
      renderLogbook();
    }

    function renderLogbook() {
      const container = document.getElementById('logbook-entries');
      container.innerHTML = '';
      const logs = JSON.parse(localStorage.getItem('logbook') || '[]');

      if (logs.length === 0) {
        container.innerHTML = '<p><em>Belum ada entri logbook.</em></p>';
        return;
      }

      logs.forEach(entry => {
        const div = document.createElement('div');
        div.style.borderBottom = '1px solid #ccc';
        div.style.padding = '8px 0';
        div.innerHTML = `
          <div><strong>${entry.timestamp}</strong> - <em>${entry.user}</em></div>
          <div>${'★'.repeat(entry.rating)}${'☆'.repeat(5 - entry.rating)}</div>
          <div>${entry.comment}</div>`;
        container.appendChild(div);
      });
    }

    function toggleForm() {
      const form = document.getElementById('formBuatUser');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function toggleUserList() {
      const section = document.getElementById('userListSection');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
      if (section.style.display === 'block') fetchUserList();
    }

    function fetchUserList() {
      fetch(`${API_BASE}/users`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
        .then(res => res.json())
        .then(users => {
          const container = document.getElementById('userListContainer');
          container.innerHTML = '';
          if (!Array.isArray(users)) {
            alert('Format data user tidak sesuai');
            return;
          }
          users.forEach(user => {
            const div = document.createElement('div');
            div.classList.add('user-row');
            div.style.padding = '6px';
            div.style.borderBottom = '1px solid #eee';
            div.innerHTML = `
              <span><strong>${user.name}</strong> (${user.email}) - ${user.role}</span>
              <button style="float:right;" onclick="deleteUser(${user.id})">🗑️</button>
            `;
            container.appendChild(div);
          });
        });
    }

    function deleteUser(userId) {
      if (!confirm('Yakin ingin menghapus akun ini?')) return;
      fetch(`${API_BASE}/users/${userId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      })
        .then(res => {
          if (res.ok) {
            alert('User berhasil dihapus');
            fetchUserList();
          } else {
            return res.json().then(json => {
              throw new Error(json.message || 'Gagal menghapus user');
            });
          }
        })
        .catch(err => alert(err.message));
    }

    function logout() {
      fetch(`${API_BASE}/logout`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      }).finally(() => {
        localStorage.removeItem('token');
        location.href = "index.html";
      });
    }

    function updateLiveClock() {
      const clockElement = document.getElementById('liveClock');
      const now = new Date();
      const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
      const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
      clockElement.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()} - ${now.toLocaleTimeString('id-ID')}`;
    }

    function toggleMode() {
      const isDark = document.body.classList.toggle("dark-mode");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }
  </script>
</body>
</html>
