<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile - SOP BURTOK</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>

@media (max-width: 768px) {
  .dashboard-wrapper {
    flex-direction: column;
  }
  .sidebar {
    display: none;
  }
  .profile-content-flex {
    flex-direction: column;
    padding: 10px;
  }
  .profile-info {
    width: 100%;
    box-shadow: none;
    padding: 10px;
  }
  #top-tools {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    flex-wrap: wrap;
  }
  .mobile-bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    border-top: 1px solid #ccc;
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    z-index: 1000;
  }
  .mobile-bottom-nav button {
    flex: 1;
    border: none;
    background: none;
    font-size: 14px;
  }
  .mobile-bottom-nav button.active {
    color: #1976d2;
    font-weight: bold;
  }
  .content {
    padding-bottom: 70px;
  }
}

    .profile-info {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .profile-info label {
      display: block;
      margin-top: 12px;
      font-weight: 500;
    }
    .profile-info input {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    .profile-info button {
      margin-top: 15px;
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .profile-info button:hover {
      background-color: #0056b3;
    }
    .profile-content-flex {
      display: flex;
      gap: 40px;
      justify-content: space-between;
      align-items: flex-start;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .equal-box {
      flex: 1;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      min-width: 300px;
      box-sizing: border-box;
    }
    @media (max-width: 768px) {
      .profile-content-flex {
        flex-direction: column;
      }
      .profile-info {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
  body {
    min-height: 100vh;
    padding-bottom: 100px;
  }

  .content {
    padding-bottom: 100px;
  }

  .dashboard-wrapper {
    flex-direction: column;
  }

  .sidebar {
    display: none;
  }

  .profile-content-flex {
    flex-direction: column;
    padding: 10px;
  }

  .profile-info {
    width: 100%;
    box-shadow: none;
    padding: 10px;
  }

  #top-tools {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    flex-wrap: wrap;
  }

  .mobile-bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    border-top: 1px solid #ccc;
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    z-index: 9999;
  }

  .mobile-bottom-nav button {
    flex: 1;
    border: none;
    background: none;
    font-size: 14px;
  }

  .mobile-bottom-nav button.active {
    color: #1976d2;
    font-weight: bold;
  }
}

    .mobile-bottom-nav button i {
  font-size: 18px;
    }

  </style>
</head>
<body>
  <div class="dashboard-wrapper">
    <div class="sidebar">
      <img src="assets/images/Logo Sop Burtok Ori.png" alt="SOP BURTOK" />
      <h3>SOP BURTOK</h3>
      <button class="menu-btn" onclick="location.href='dashboard.html'">Home</button>
      <button class="menu-btn" onclick="location.href='inventory.html'">Inventory</button>
      <button class="menu-btn" onclick="location.href='production.html'">Production</button>
      <button class="menu-btn" onclick="location.href='reporting.html'">Reporting</button>
      <button class="menu-btn active" onclick="location.href='profile.html'">Profile</button>
    </div>
    <div id="top-tools">
      <div id="liveClock" style="font-weight: bold;"></div>
      <button class="toggle-mode-btn" onclick="toggleMode()">🌓</button>
      <button class="logout-btn" onclick="logoutUser()">Logout</button>
    </div>
    <div class="content">
      <div class="profile-content-flex">
        <div class="profile-info">
          <h2>Halaman Profile</h2>
          <label>Nama Lengkap</label>
          <input id="nama" type="text" placeholder="Nama Lengkap">
          <label>Email</label>
          <input id="email" type="text" disabled placeholder="Email">
          <label>No. HP</label>
          <input id="hp" type="text" placeholder="08xxxxxxxx">
          <label>Alamat</label>
          <input id="alamat" type="text" placeholder="Alamat lengkap">
          <button onclick="updateProfile()">Update</button>
          <button onclick="togglePasswordForm()">Ganti Password</button>
          <div id="passwordForm" style="display: none; margin-top: 10px;">
            <input id="old_password" type="password" placeholder="Password Lama" />
            <input id="new_password" type="password" placeholder="Password Baru" />
            <input id="confirm_password" type="password" placeholder="Konfirmasi Password Baru" />
            <button onclick="changePassword()">Simpan Password</button>
          </div>
        </div>
      </div>
      <div id="admin-section" style="display: none; margin-top: 15px;">
        <button onclick="toggleForm()">+ Tambah Akun Baru</button>
        <div id="formBuatUser" style="display: none; border: 1px solid #ccc; padding: 15px; margin-top: 10px;">
          <h3>Buat Akun Baru</h3>
          <input id="new_name" type="text" placeholder="Nama Lengkap" >
          <input id="new_email" type="email" placeholder="Email" >
          <input id="user_password" type="password" placeholder="Password" >
          <input id="new_hp" type="text" placeholder="No HP (opsional)" >
          <input id="new_alamat" type="text" placeholder="Alamat (opsional)" >
          <select id="new_role">
            <option value="admin">Admin</option>
            <option value="manager">Manager</option>
            <option value="staff">Staf</option>
          </select>
          <button onclick="createUser()">Buat Akun</button>
        </div>
        <button onclick="toggleUserList()" style="margin-top: 15px;">👥 Lihat Daftar Akun</button>
        <div id="userListSection" style="display: none; margin-top: 15px;">
          <h3>Daftar Akun Terdaftar</h3>
          <div id="userListContainer"></div>
        </div>
      </div>
    </div>
  </div>
<script>
  const API_BASE = 'https://api.sopburtok.giize.com/api';
  const token = localStorage.getItem('token');
  if (!token) {
    alert("Anda belum login. Silakan login ulang.");
    location.href = "index.html";
  }
  document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-mode');
    }
    fetchProfile();
    updateLiveClock();
    setInterval(updateLiveClock, 1000);
  });
  function fetchProfile() {
    fetch(`${API_BASE}/user-profile`, {
      headers: { 'Authorization': `Bearer ${token}` }
    })
      .then(res => res.json())
      .then(user => {
        document.getElementById('nama').value = user.name || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('hp').value = user.phone || '';
        document.getElementById('alamat').value = user.address || '';
        localStorage.setItem('currentEmail', user.email);
        if (user.role === 'admin') {
          document.getElementById('admin-section').style.display = 'block';
        }
      })
      .catch(() => alert('Gagal mengambil data profil'));
  }
  function updateProfile() {
    const data = {
      name: document.getElementById('nama').value,
      phone: document.getElementById('hp').value,
      address: document.getElementById('alamat').value
    };
    fetch(`${API_BASE}/user-profile`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
      .then(res => res.json())
      .then(response => alert(response.message || 'Profil berhasil diperbarui'))
      .catch(() => alert('Terjadi kesalahan saat memperbarui profil'));
  }
  function toggleForm() {
    const form = document.getElementById('formBuatUser');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
  }
  function toggleUserList() {
    const section = document.getElementById('userListSection');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
    if (section.style.display === 'block') fetchUserList();
  }
  function fetchUserList() {
    fetch(`${API_BASE}/users`, {
      headers: { 'Authorization': `Bearer ${token}` }
    })
      .then(res => res.json())
      .then(users => {
        const container = document.getElementById('userListContainer');
        container.innerHTML = '';
        if (!Array.isArray(users)) {
          alert('Format data user tidak sesuai');
          return;
        }
        const currentEmail = localStorage.getItem('currentEmail');
        users.forEach(user => {
          const div = document.createElement('div');
          div.classList.add('user-row');
          div.style.padding = '6px';
          div.style.borderBottom = '1px solid #eee';
          const isActive = user.email === currentEmail;
          div.innerHTML = `
            <span>${isActive ? '<strong>' : ''}${user.name} (${user.email}) - ${user.role}${isActive ? '</strong>' : ''}</span>
            <button style="float:right;" onclick="deleteUser(${user.id})">🗑️</button>
          `;
          container.appendChild(div);
        });
      });
  }
  function createUser() {
    const password = document.getElementById('user_password').value;
    if (!password || password.trim() === '') {
      alert('Password harus diisi!');
      return;
    }
    const data = {
      name: document.getElementById('new_name').value,
      email: document.getElementById('new_email').value,
      password: password,
      phone: document.getElementById('new_hp').value,
      address: document.getElementById('new_alamat').value,
      role: document.getElementById('new_role').value
    };
    fetch(`${API_BASE}/users`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(data)
    })
    .then(res => {
      if (!res.ok) {
        return res.json().then(err => { throw new Error(err.message); });
      }
      return res.json();
    })
    .then(response => {
      alert('Akun berhasil dibuat');
      fetchUserList();
    })
    .catch(err => {
      alert('Gagal membuat akun: ' + err.message);
    });
  }
  function deleteUser(userId) {
    if (!confirm('Yakin ingin menghapus akun ini?')) return;
    fetch(`${API_BASE}/users/${userId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(res => {
      if (res.ok) {
        alert('User berhasil dihapus');
        fetchUserList();
      } else {
        return res.json().then(json => {
          throw new Error(json.message || 'Gagal menghapus user');
        });
      }
    })
    .catch(err => alert(err.message));
  }
  function Notesout() {
    fetch(`${API_BASE}/Notesout`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    }).finally(() => {
      localStorage.removeItem('token');
      location.href = "index.html";
    });
  }
  function updateLiveClock() {
    const clockElement = document.getElementById('liveClock');
    const now = new Date();
    const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
    const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
    clockElement.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()} - ${now.toLocaleTimeString('id-ID')}`;
  }
  function toggleMode() {
    const isDark = document.body.classList.toggle("dark-mode");
    localStorage.setItem("theme", isDark ? "dark" : "light");
  }
  function togglePasswordForm() {
    const form = document.getElementById('passwordForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
  }
  function changePassword() {
    const oldPassword = document.getElementById('old_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    if (!oldPassword || !newPassword || !confirmPassword) {
      alert('Semua kolom password harus diisi.');
      return;
    }
    if (newPassword !== confirmPassword) {
      alert('Konfirmasi password tidak cocok.');
      return;
    }
    fetch(`${API_BASE}/change-password`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        old_password: oldPassword,
        new_password: newPassword
      })
    })
      .then(res => res.json())
      .then(response => {
        alert(response.message || 'Password berhasil diubah');
        document.getElementById('passwordForm').style.display = 'none';
      })
      .catch(() => alert('Gagal mengubah password'));
  }
</script>

  <div class="mobile-bottom-nav">
    <button onclick="location.href='dashboard.html'"><i class="fas fa-home"></i></button>
    <button onclick="location.href='inventory.html'"><i class="fas fa-box"></i></button>
    <button onclick="location.href='production.html'"><i class="fas fa-industry"></i></button>
    <button onclick="location.href='reporting.html'"><i class="fas fa-chart-bar"></i></button>
    <button class="active" onclick="location.href='profile.html'"><i class="fas fa-user"></i></button>
  </div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const path = window.location.pathname.split('/').pop();
    const buttons = document.querySelectorAll(".mobile-bottom-nav button");
    buttons.forEach(btn => {
      const href = btn.getAttribute("onclick").match(/'(.*?)'/)?.[1];
      if (href === path) {
        btn.classList.add("active");
      }
    });
  });
</script>

</body>
</html>
