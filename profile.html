<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Profile - SOP BURTOK</title>
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
<div class="dashboard-wrapper">
  <div class="sidebar">
    <img src="assets/images/logo.png" alt="SOP BURTOK">
    <h3>SOP BURTOK</h3>
    <button class="menu-btn" onclick="location.href='dashboard.html'">Home</button>
    <button class="menu-btn" onclick="location.href='inventory.html'">Inventory</button>
    <button class="menu-btn" onclick="location.href='production.html'">Production</button>
    <button class="menu-btn" onclick="location.href='reporting.html'">Reporting</button>
    <button class="menu-btn active" onclick="location.href='profile.html'">Profile</button>
  </div>

  <div class="top-bar">
    <div id="liveClock" style="margin-right: 15px; font-weight: bold;"></div>
    <button class="toggle-mode-btn" onclick="toggleMode()" style="margin-right: 10px;">üåì</button>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="content">
    <div class="profile-content">
      <h2>Halaman Profile</h2>
      <div class="profile-info">
        <label>Nama</label>
        <input id="nama" type="text" placeholder="Nama Anda">

        <label>Email</label>
        <input id="email" type="text" disabled>

        <label>No. HP</label>
        <input id="hp" type="text" placeholder="08xxxxxxxx">

        <label>Alamat</label>
        <input id="alamat" type="text" placeholder="Alamat lengkap">

        <button onclick="updateProfile()">Update</button>
      </div>

      <!-- Admin-only section -->
      <div id="admin-section" style="display: none; margin-top: 40px;">
        <button onclick="toggleForm()" style="margin-bottom: 10px;">+ Tambah Akun Baru</button>

        <div id="formBuatUser" style="display: none; border: 1px solid #ccc; padding: 15px;">
          <h3>Buat Akun Baru</h3>
          <input id="new_name" type="text" placeholder="Nama Lengkap"><br>
          <input id="new_email" type="email" placeholder="Email"><br>
          <input id="new_password" type="password" placeholder="Password"><br>
          <input id="new_hp" type="text" placeholder="No HP (opsional)"><br>
          <input id="new_alamat" type="text" placeholder="Alamat (opsional)"><br>
          <select id="new_role">
            <option value="staff">Staf</option>
            <option value="admin">Admin</option>
          </select><br>
          <button onclick="createUser()">Buat Akun</button>
        </div>

        <button onclick="toggleUserList()" style="margin-top: 20px;">üë• Lihat Daftar Akun</button>

        <div id="userListSection" style="display: none; margin-top: 15px;">
          <h3>Daftar Akun Terdaftar</h3>
          <div id="userListContainer"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://api.sopburtok.giize.com/api';
const token = localStorage.getItem('token');
if (!token) location.href = 'index.html';

document.addEventListener('DOMContentLoaded', () => {
  if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark-mode');
  }

  fetchProfile();
  updateLiveClock();
  setInterval(updateLiveClock, 1000);
});

function fetchProfile() {
  fetch(`${API_BASE}/user-profile`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(user => {
    document.getElementById('nama').value = user.name || '';
    document.getElementById('email').value = user.email || '';
    document.getElementById('hp').value = user.phone || '';
    document.getElementById('alamat').value = user.address || '';

    if (user.role === 'admin') {
      document.getElementById('admin-section').style.display = 'block';
    }
  })
  .catch(() => alert('Gagal mengambil data profil'));
}

function updateProfile() {
  const data = {
    name: document.getElementById('nama').value,
    phone: document.getElementById('hp').value,
    address: document.getElementById('alamat').value
  };

  fetch(`${API_BASE}/user-profile`, {
    method: 'PUT',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(response => {
    alert(response.message || 'Profil berhasil diperbarui');
  })
  .catch(() => alert('Terjadi kesalahan saat memperbarui profil'));
}

function toggleForm() {
  const form = document.getElementById('formBuatUser');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function createUser() {
  const name = document.getElementById('new_name').value;
  const email = document.getElementById('new_email').value;
  const password = document.getElementById('new_password').value;

  if (!name || !email || !password) {
    alert('Nama, email dan password wajib diisi');
    return;
  }

  const data = {
    name,
    email,
    password,
    phone: document.getElementById('new_hp').value,
    address: document.getElementById('new_alamat').value,
    role: document.getElementById('new_role').value
  };

  fetch(`${API_BASE}/users`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(async res => {
    const json = await res.json();
    if (!res.ok) throw new Error(json.message || 'Gagal membuat akun');

    alert(json.message || 'Akun berhasil dibuat');

    // ‚úÖ Reset form tambah user
    document.getElementById('new_name').value = '';
    document.getElementById('new_email').value = '';
    document.getElementById('new_password').value = '';
    document.getElementById('new_hp').value = '';
    document.getElementById('new_alamat').value = '';
    document.getElementById('new_role').value = 'staff';

    fetchUserList(); // ‚¨ÖÔ∏è hanya refresh daftar, bukan profile
  })
  .catch(err => alert(err.message));
}


function toggleUserList() {
  const section = document.getElementById('userListSection');
  if (section.style.display === 'none') {
    section.style.display = 'block';
    fetchUserList();
  } else {
    section.style.display = 'none';
  }
}

function fetchUserList() {
  fetch(`${API_BASE}/users`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(users => {
    const container = document.getElementById('userListContainer');
    container.innerHTML = '';

    if (!Array.isArray(users)) {
      alert('Format data user tidak sesuai');
      return;
    }

    if (users.length === 0) {
      container.innerHTML = '<p><em>Tidak ada user terdaftar.</em></p>';
      return;
    }

    users.forEach(user => {
      const div = document.createElement('div');
      div.classList.add('user-row');
      div.style.padding = '6px';
      div.style.borderBottom = '1px solid #eee';
      div.innerHTML = `
        <span><strong>${user.name}</strong> (${user.email}) - ${user.role}</span>
        <button style="float:right;" onclick="deleteUser(${user.id})">üóëÔ∏è</button>
      `;
      container.appendChild(div);
    });
  })
  .catch(() => alert('Gagal memuat daftar user'));
}

function deleteUser(userId) {
  if (!confirm('Yakin ingin menghapus akun ini?')) return;

  fetch(`${API_BASE}/users/${userId}`, {
    method: 'DELETE',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => {
    if (res.ok) {
      alert('User berhasil dihapus');
      fetchUserList();
    } else {
      return res.json().then(json => {
        throw new Error(json.message || 'Gagal menghapus user');
      });
    }
  })
  .catch(err => alert(err.message));
}

function logout() {
  fetch(`${API_BASE}/logout`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  }).finally(() => {
    localStorage.removeItem('token');
    location.href = "index.html";
  });
}

function updateLiveClock() {
  const clockElement = document.getElementById('liveClock');
  if (!clockElement) return;

  const now = new Date();
  const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];

  clockElement.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()} - ${now.toLocaleTimeString('id-ID')}`;
}

function toggleMode() {
  const isDark = document.body.classList.toggle('dark-mode');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
}
</script>

</body>
</html>
